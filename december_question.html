<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>December Quiz Sets - Stethoscope & Study</title>

    <link rel="icon" href="stethoscope-and-study-logo1.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: #ffffff;
            --text-dark: #2d3748;
            --text-light: #718096;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --info: #4299e1;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --nav-height: 76px;
            --primary-color: #667eea;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: #f7fafc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: var(--nav-height);
            color: var(--text-dark);
        }

        /* --- Navbar Styles --- */
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .nav-link { position: relative; color: #4a5568 !important; font-weight: 500; transition: color 0.3s ease; }
        .nav-link:hover, .nav-link.active { color: var(--primary-color) !important; }

        main {
            flex: 1;
            padding: 40px 20px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- Improved Set Card Design --- */
        .set-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .set-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            border-color: rgba(102, 126, 234, 0.3);
        }

        /* Status Indicators (Top Right Badge) */
        .status-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.35rem 0.8rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Status Colors */
        .set-card.status-upcoming { border-top: 4px solid var(--warning); }
        .set-card.status-upcoming .status-badge { background: #fffaf0; color: var(--warning); border: 1px solid #fbd38d; }
        
        .set-card.status-open { border-top: 4px solid var(--success); }
        .set-card.status-open .status-badge { background: #f0fff4; color: var(--success); border: 1px solid #9ae6b4; }
        
        .set-card.status-closed { border-top: 4px solid var(--text-light); }
        .set-card.status-closed .status-badge { background: #edf2f7; color: var(--text-light); border: 1px solid #cbd5e0; }
        
        .set-card.status-completed { border-top: 4px solid var(--info); }
        .set-card.status-completed .status-badge { background: #ebf8ff; color: var(--info); border: 1px solid #90cdf4; }

        .set-info { margin-top: 1.5rem; flex-grow: 1; }
        .set-info h5 { 
            font-weight: 700; 
            color: var(--text-dark); 
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
            line-height: 1.4;
        }
        
        .set-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        /* Modern Countdown Timer */
        .timer-container {
            background: #f7fafc;
            border-radius: 12px;
            padding: 0.75rem;
            text-align: center;
            margin-top: auto;
            border: 1px solid #e2e8f0;
        }
        
        .timer-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-light);
            margin-bottom: 4px;
            display: block;
            font-weight: 600;
        }
        
        .timer-value {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-dark);
            letter-spacing: -0.5px;
        }

        .timer-icon { margin-right: 5px; }
        
        /* Timer Specific Colors */
        .set-card.status-upcoming .timer-value { color: var(--warning); }
        .set-card.status-open .timer-value { color: var(--success); }
        .set-card.status-closed .timer-value { color: var(--danger); text-decoration: line-through; opacity: 0.7; }

        /* Loader */
        .loader { width: 100%; text-align: center; padding: 3rem; color: var(--primary-color); }

        /* --- Quiz UI --- */
        .section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .quiz-container { background: white; border-radius: 20px; box-shadow: var(--shadow-md); overflow: hidden; position: relative; max-width: 800px; margin: 0 auto; }
        .quiz-header { background: var(--primary-gradient); color: white; padding: 2rem; display: flex; justify-content: space-between; align-items: center; }
        .quiz-body { padding: 2rem; }
        .question-text { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--text-dark); }
        
        .option-btn-styled { 
            background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; 
            padding: 1rem 1.25rem 1rem 3.5rem; width: 100%; text-align: left; 
            margin-bottom: 0.75rem; position: relative; font-weight: 500;
            transition: all 0.2s; cursor: pointer; color: #4a5568;
        }
        .option-btn-styled::before {
            content: attr(data-letter); position: absolute; left: 1rem; top: 50%; 
            transform: translateY(-50%); width: 30px; height: 30px; 
            background: #edf2f7; border-radius: 8px; display: flex; 
            align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem;
        }
        .option-btn-styled:hover { border-color: var(--primary-color); background: #ebf4ff; }
        .option-btn-styled.correct { background: #f0fff4; border-color: var(--success); color: #22543d; }
        .option-btn-styled.wrong { background: #fff5f5; border-color: var(--danger); color: #742a2a; }

        .btn-quit { padding: 10px 25px; border-radius: 50px; border: 2px solid #cbd5e0; background: transparent; color: var(--text-light); font-weight: 600; transition: 0.3s; }
        .btn-quit:hover { border-color: var(--danger); color: var(--danger); }

        /* Footer */
        .footer-custom { background-color: #1a202c; color: #a0aec0; padding: 2rem 0; text-align: center; margin-top: auto; border-top: 4px solid var(--primary-color); }
        
        @media (max-width: 768px) {
            .set-card { margin-bottom: 1rem; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <span class="fw-bold" style="color: #2d3748;">Stethoscope & <span style="color: var(--primary-color);">Study</span></span>
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-3">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="Quiz_Dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="leaderboard.html">Leaderboard</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle btn btn-light rounded-pill px-3" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="border: 1px solid #e2e8f0;">
                            <i class="fas fa-user-circle fa-lg me-1"></i> <span id="nav-user-name">Account</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0" id="profile-menu-items">
                             <li><a class="dropdown-item" href="index.html">Login</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <div id="set-menu-section" class="section active">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h2 class="fw-bold mb-1">December Quizzes</h2>
                    <p class="text-muted mb-0">Join the live challenges or prepare for upcoming ones.</p>
                </div>
                <a href="Quiz_Dashboard.html" class="btn btn-outline-secondary rounded-pill px-4">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
            </div>
            
            <div id="sets-container" class="row g-4">
                 <div class="loader">
                     <div class="spinner-border" role="status"></div>
                     <p class="mt-3 fw-medium">Loading Quiz Sets...</p>
                 </div>
            </div>
        </div>

        <div id="quiz-area" class="section mt-4">
            <div class="quiz-container">
                <div style="height: 6px; background: #edf2f7; width: 100%;"><div style="height: 100%; background: #48bb78; width: 0%; transition: width 0.5s;" id="progress-bar"></div></div>
                
                <div class="quiz-header">
                    <div>
                        <h5 class="mb-1 fw-bold">Medical Quiz Challenge</h5>
                        <div class="small opacity-75" id="quiz-subtitle">Loading...</div>
                    </div>
                    <div class="score-badge">Score: <span id="current-score">0</span></div>
                </div>
                
                <div class="quiz-body">
                    <div class="d-flex justify-content-between text-muted small fw-bold mb-3 text-uppercase letter-spacing-1">
                        <span>Question <span id="q-idx">1</span> of <span id="q-total">10</span></span>
                        <span>Single Choice</span>
                    </div>
                    
                    <div class="question-text" id="q-text">Loading Question...</div>
                    <div id="options-container"></div>
                </div>
            </div>
            
            <div class="text-center mt-5">
                <button class="btn btn-quit" onclick="quitQuiz()">
                    <i class="fas fa-sign-out-alt me-2"></i>Exit Quiz
                </button>
            </div>
        </div>
    </main>

    <footer class="footer-custom">
        <div class="container small">
            &copy; 2025 Stethoscope & Study. All rights reserved.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, increment, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ----------------------------------------------------
        // IMPORTANT: Import Config from env.js to hide keys
        // ----------------------------------------------------
        import CONFIG from './env.js';

        // Initialize Firebase with CONFIG
        const app = initializeApp(CONFIG.FIREBASE);
        const db = getFirestore(app);

        let currentUser = null;
        let currentQuestions = [];
        let currentSetData = null;
        let qIndex = 0;
        let score = 0;
        let timerInterval = null;

        // AUTH & INIT
        window.onload = async () => {
            const savedEmail = localStorage.getItem("userEmail");
            if (savedEmail) {
                await fetchUserData(savedEmail);
            } else {
                updateProfileMenu(); 
            }
            
            loadDecemberSets();

            const urlParams = new URLSearchParams(window.location.search);
            const setIdFromUrl = urlParams.get('id');
            if(setIdFromUrl && currentUser) {
                initiateQuiz(setIdFromUrl);
            }
        };

        async function fetchUserData(email) {
            try {
                const snap = await getDoc(doc(db, "users", email));
                if(snap.exists()) {
                    currentUser = snap.data();
                    updateProfileMenu();
                }
            } catch (e) { console.error(e); }
        }

        function updateProfileMenu() {
            const menu = document.getElementById('profile-menu-items');
            const userNameDisplay = document.getElementById('nav-user-name');
            if (currentUser) {
                userNameDisplay.innerText = currentUser.name.split(' ')[0];
                menu.innerHTML = `
                    <li><h6 class="dropdown-header">Hi, ${currentUser.name}</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="leaderboard.html">My Ranking</a></li>
                    <li><a class="dropdown-item text-danger" href="#" id="logout-btn">Sign Out</a></li>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem("userEmail");
                    window.location.href = "index.html";
                });
            } else {
                userNameDisplay.innerText = "Guest";
                menu.innerHTML = `<li><a class="dropdown-item" href="index.html">Log In</a></li>`;
            }
        }

        // --- TIME FORMATTER ---
        function formatTime(ms) {
            if (ms <= 0) return "00 : 00 : 00 : 00";
            const d = Math.floor(ms / (1000 * 60 * 60 * 24));
            const h = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((ms % (1000 * 60)) / 1000);
            
            const pad = (n) => n.toString().padStart(2, '0');
            return `${pad(d)} : ${pad(h)} : ${pad(m)} : ${pad(s)}`;
        }

        // --- LOAD SETS ---
        async function loadDecemberSets() {
            const container = document.getElementById('sets-container');
            
            try {
                const q = query(
                    collection(db, "quiz_sets"), 
                    where("target_month", "==", "December"),
                    where("academic_year", "==", 2025)
                );
                const querySnapshot = await getDocs(q);

                container.innerHTML = "";
                if (querySnapshot.empty) {
                    container.innerHTML = "<div class='col-12 text-center text-muted py-5'><h5>No active quizzes found for December.</h5></div>";
                    return;
                }

                const timerData = [];

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const setId = docSnap.id;
                    
                    const start = data.scoring_start_date ? data.scoring_start_date.toDate() : null;
                    const end = data.scoring_end_date ? data.scoring_end_date.toDate() : null;
                    
                    // Determine Status
                    let statusClass = "status-upcoming";
                    let badgeText = "Upcoming";
                    let badgeIcon = "fa-hourglass-half";
                    
                    const now = new Date();
                    
                    if(start && now >= start && now <= end) {
                        statusClass = "status-open";
                        badgeText = "Live Now";
                        badgeIcon = "fa-broadcast-tower";
                    } else if (end && now > end) {
                        statusClass = "status-closed";
                        badgeText = "Expired";
                        badgeIcon = "fa-lock";
                    }

                    // Collect timer data
                    if(start && end) {
                        timerData.push({ id: setId, start, end });
                    }

                    const html = `
                    <div class="col-md-6 col-lg-4">
                        <div class="set-card ${statusClass}" onclick="initiateQuiz('${setId}')" id="card-${setId}">
                            
                            <div class="status-badge">
                                <i class="fas ${badgeIcon}"></i> ${badgeText}
                            </div>

                            <div class="set-info">
                                <h5>${data.set_name}</h5>
                                <div class="set-meta">
                                    <span><i class="far fa-file-alt me-1"></i> ${data.total_questions || 10} Qs</span>
                                    <span><i class="far fa-star me-1"></i> High Yield</span>
                                </div>
                            </div>

                            <div class="timer-container">
                                <span class="timer-label" id="label-${setId}">Time Remaining</span>
                                <div class="timer-value" id="timer-${setId}">-- : -- : -- : --</div>
                            </div>

                        </div>
                    </div>`;
                    container.innerHTML += html;
                });

                startTimerLoop(timerData);

            } catch (e) {
                console.error("Error:", e);
                container.innerHTML = "<p class='text-danger text-center'>Failed to load content.</p>";
            }
        }

        function startTimerLoop(items) {
            if(timerInterval) clearInterval(timerInterval);

            const update = () => {
                const now = new Date();
                items.forEach(item => {
                    const timerEl = document.getElementById(`timer-${item.id}`);
                    const labelEl = document.getElementById(`label-${item.id}`);
                    const card = document.getElementById(`card-${item.id}`);
                    
                    if(!timerEl) return;

                    if (now < item.start) {
                        // UPCOMING
                        const diff = item.start - now;
                        labelEl.innerText = "Starts In";
                        timerEl.innerText = formatTime(diff);
                        
                        // Update classes dynamically if needed
                        if(!card.classList.contains('status-upcoming')) {
                            card.className = "set-card status-upcoming";
                        }
                    } 
                    else if (now >= item.start && now <= item.end) {
                        // LIVE
                        const diff = item.end - now;
                        labelEl.innerText = "Ends In";
                        timerEl.innerText = formatTime(diff);
                        
                        if(!card.classList.contains('status-open')) {
                            card.className = "set-card status-open";
                        }
                    } 
                    else {
                        // EXPIRED
                        labelEl.innerText = "Status";
                        timerEl.innerText = "EXPIRED";
                        
                        if(!card.classList.contains('status-closed')) {
                            card.className = "set-card status-closed";
                        }
                    }
                });
            };

            update();
            timerInterval = setInterval(update, 1000);
        }

        // --- QUIZ FUNCTIONS ---
        window.switchSection = (targetId) => {
            if(targetId !== 'set-menu-section' && timerInterval) clearInterval(timerInterval);
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            window.scrollTo(0, 0);
        };

        window.quitQuiz = () => {
            if(confirm("Quit quiz? Progress won't be saved.")) window.location.reload();
        };

        window.initiateQuiz = async (setId) => {
            if (!currentUser) {
                alert("Please login first!");
                window.location.href = "index.html";
                return;
            }

            // Check if done
            const resQ = query(
                collection(db, "user_quiz_results"),
                where("user_id", "==", currentUser.user_id || currentUser.email), 
                where("set_id", "==", setId)
            );
            
            try {
                const resSnap = await getDocs(resQ);
                if(!resSnap.empty) {
                    if(!confirm("You completed this set. Practice again? (Score won't update)")) return;
                }
                
                // Fetch Data
                const setRef = doc(db, "quiz_sets", setId);
                const setSnap = await getDoc(setRef);
                
                if(!setSnap.exists()) return alert("Set not found!");
                currentSetData = { id: setId, ...setSnap.data() };
                
                // Validate Time
                const now = new Date();
                const start = currentSetData.scoring_start_date ? currentSetData.scoring_start_date.toDate() : null;
                if(start && now < start) return alert("Quiz hasn't started yet!");

                // Fetch Qs
                const qQuery = query(collection(db, "questions"), where("set_id", "==", setId));
                const qSnap = await getDocs(qQuery);
                
                if(qSnap.empty) return alert("Questions unavailable.");
                
                currentQuestions = [];
                qSnap.forEach(doc => currentQuestions.push(doc.data()));
                
                startQuizUI();

            } catch(e) { console.error(e); }
        };

        function startQuizUI() {
            window.switchSection('quiz-area');
            document.getElementById('quiz-subtitle').innerText = currentSetData.set_name;
            document.getElementById('q-total').innerText = currentQuestions.length;
            qIndex = 0; score = 0;
            document.getElementById('progress-bar').style.width = '0%';
            loadQuestion();
        }

        function loadQuestion() {
            if(qIndex >= currentQuestions.length) return finishQuiz();
            
            const q = currentQuestions[qIndex];
            const progress = (qIndex / currentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;

            const qText = document.getElementById('q-text');
            qText.innerText = q.question_text; 
            document.getElementById('q-idx').innerText = qIndex + 1;
            document.getElementById('current-score').innerText = score;
            
            const box = document.getElementById('options-container');
            box.innerHTML = "";
            const letters = ['A', 'B', 'C', 'D'];
            const optionsArr = [q.option_a, q.option_b, q.option_c, q.option_d];
            
            optionsArr.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "option-btn-styled";
                btn.setAttribute('data-letter', letters[idx]);
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(['a','b','c','d'][idx], btn, q.correct_option); 
                box.appendChild(btn);
            });
        }

        function handleAnswer(selected, btn, correct) {
            document.querySelectorAll('.option-btn-styled').forEach(b => {
                b.disabled = true; b.style.cursor = 'default';
            });

            if(String(selected).toLowerCase() === String(correct).toLowerCase()) { 
                btn.classList.add('correct', 'pop-success'); score++; 
            } else { 
                btn.classList.add('wrong', 'pop-failure');
            }
            setTimeout(() => { qIndex++; loadQuestion(); }, 1000);
        }

        async function finishQuiz() {
            document.getElementById('progress-bar').style.width = '100%';
            if (currentUser) {
                try {
                    const now = new Date();
                    let isEligible = false;
                    const start = currentSetData.scoring_start_date ? currentSetData.scoring_start_date.toDate() : null;
                    const end = currentSetData.scoring_end_date ? currentSetData.scoring_end_date.toDate() : null;

                    if (start && end) { if (now >= start && now <= end) isEligible = true; } 
                    else { isEligible = true; }

                    await addDoc(collection(db, "user_quiz_results"), {
                        user_id: currentUser.user_id || currentUser.email, 
                        set_id: currentSetData.id,
                        score_obtained: score,
                        total_marks: currentQuestions.length,
                        attempted_at: serverTimestamp(),
                        is_eligible_for_leaderboard: isEligible
                    });

                    if (isEligible) {
                        const userRef = doc(db, "users", currentUser.email);
                        await updateDoc(userRef, {
                            total_score: increment(score),
                            monthly_score: increment(score)
                        });
                        alert(`Finished! Score: ${score}/${currentQuestions.length}. Leaderboard Updated.`);
                    } else {
                        alert(`Finished! Score: ${score}/${currentQuestions.length}. (Not eligible for ranking)`);
                    }
                } catch (e) { console.error(e); }
            }
            window.location.reload();
        }
    </script>
</body>
</html>