<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stethoscope & Study Portal</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd;
            /* Bootstrap Primary */
            --nav-height: 76px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            padding-top: var(--nav-height);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Main wrapper to push footer down */
        main {
            flex: 1;
        }

        /* Smooth transitions for sections */
        .section {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Decorated Navbar --- */
        .navbar {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .navbar-brand img {
            height: 40px;
            margin-right: 10px;
        }

        /* Nav Link Animations */
        .nav-link {
            position: relative;
            color: #555 !important;
            font-weight: 500;
            padding-bottom: 5px;
            transition: color 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--primary-color) !important;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 0;
            background: linear-gradient(90deg, var(--primary-color), #00c6ff);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after,
        .nav-link.active::after {
            width: 100%;
        }

        /* --- Decorated Footer --- */
        .footer-custom {
            background-color: #1e293b;
            /* Dark Slate Blue */
            color: #94a3b8;
            padding-top: 3rem;
            margin-top: 4rem;
            border-top: 4px solid var(--primary-color);
        }

        .footer-title {
            color: #fff;
            font-weight: 600;
            margin-bottom: 1.2rem;
            position: relative;
            display: inline-block;
        }

        .footer-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 40px;
            height: 2px;
            background-color: var(--primary-color);
        }

        .footer-link {
            color: #94a3b8;
            text-decoration: none;
            display: block;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .footer-link:hover {
            color: #fff;
            padding-left: 5px;
        }

        .social-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            margin-right: 8px;
            transition: all 0.3s;
            text-decoration: none;
        }

        .social-btn:hover {
            background: var(--primary-color);
            transform: translateY(-3px);
            color: #fff;
        }

        .copyright-bar {
            background-color: #0f172a;
            padding: 1.5rem 0;
            margin-top: 3rem;
        }

        /* Custom Card Styling */
        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }
        
        /* Home Page Decorations */
        .hero-section {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            padding: 80px 0 60px;
            border-radius: 0 0 50% 50% / 4%;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .hero-title {
            background: -webkit-linear-gradient(45deg, var(--primary-color), #00c6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 1.8rem;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .feature-card:hover .feature-icon {
            transform: scale(1.1) rotate(10deg);
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .opacity-10 {
            opacity: 0.1;
        }

        .hide {
            display: none !important;
        }
    </style>
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#" onclick="navTo('home')">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                    style="width: 40px; height: 40px;">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <span class="fw-bold" style="color: #333;">Stethoscope & <span class="text-primary">Study</span></span>
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-3">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="navTo('home')">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Quiz_Dashboard.html">Quiz Portal</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="leaderboard.html"
                            onclick="checkAuthAndNav('leaderboard')">Leaderboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://www.youtube.com" target="_blank">Tutorials</a>
                    </li>

                    <!-- Profile Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle btn btn-light rounded-pill px-3" href="#" id="navbarDropdown"
                            role="button" data-bs-toggle="dropdown" aria-expanded="false"
                            style="border: 1px solid #eee;">
                            <i class="fas fa-user-circle fa-lg me-1"></i> <span id="nav-user-name">Account</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0" id="profile-menu-items">
                            <!-- Populated by JS -->
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content Wrapper -->
    <main>
        <!-- Home Section (Decorated) -->
        <div id="section-home" class="section active">
            <!-- Hero Area -->
            <div class="hero-section text-center">
                <!-- Background Blob Effects -->
                <div class="position-absolute top-0 start-0 translate-middle rounded-circle bg-primary opacity-10"
                    style="width: 400px; height: 400px; filter: blur(80px);"></div>
                <div class="position-absolute bottom-0 end-0 translate-middle rounded-circle bg-info opacity-10"
                    style="width: 300px; height: 300px; filter: blur(60px);"></div>

                <div class="container position-relative z-1">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="mb-4">
                                <i class="fas fa-heartbeat fa-4x text-primary mb-3 animate-pulse"></i>
                            </div>
                            <h1 class="display-3 fw-bold mb-3 hero-title">Stethoscope & Study</h1>
                            <p class="lead text-secondary mb-5 fs-4">Master medical concepts through daily challenges,
                                track your progress, and compete with peers worldwide.</p>

                            <div class="d-flex gap-3 justify-content-center flex-wrap">
                                <a href="Quiz_Dashboard.html" class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm">
                                    <i class="fas fa-play me-2"></i>Start Quiz
                                </a>
                                <a href="leaderboard.html">
                                    <button class="btn btn-outline-primary btn-lg px-4 rounded-pill"
                                        onclick="checkAuthAndNav('leaderboard')">
                                        <i class="fas fa-trophy me-2"></i>Leaderboard
                                    </button>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Features Grid -->
            <div class="container py-5">
                <div class="row g-4 text-center">
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm p-4 feature-card card-custom">
                            <div class="feature-icon bg-primary bg-opacity-10 text-primary">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <h4 class="fw-bold">Monthly Quizzes</h4>
                            <p class="text-muted">Fresh, high-yield medical questions updated every month to keep your
                                knowledge sharp.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm p-4 feature-card card-custom">
                            <div class="feature-icon bg-success bg-opacity-10 text-success">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h4 class="fw-bold">Track Growth</h4>
                            <p class="text-muted">Monitor your performance over time and visualize your learning curve.
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm p-4 feature-card card-custom">
                            <div class="feature-icon bg-warning bg-opacity-10 text-warning">
                                <i class="fas fa-globe-americas"></i>
                            </div>
                            <h4 class="fw-bold">Global Ranking</h4>
                            <p class="text-muted">Compete with medical students and professionals from around the world.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Motivational Quote -->
            <div class="container pb-5">
                <div class="card bg-primary text-white border-0 rounded-4 overflow-hidden shadow">
                    <div class="card-body p-5 text-center position-relative">
                        <i class="fas fa-quote-left fa-3x position-absolute top-0 start-0 m-3 opacity-25"></i>
                        <blockquote class="blockquote mb-0 position-relative z-1">
                            <p class="fs-4 fst-italic">"Medicine is a science of uncertainty and an art of probability."
                            </p>
                            <footer class="blockquote-footer text-white-50 mt-2 fs-6">William Osler</footer>
                        </blockquote>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auth Section -->
        <div id="section-auth" class="section">
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-md-6 col-lg-5">
                        <div class="card card-custom p-4">
                            <div class="card-body">
                                <h3 class="text-center mb-3" id="auth-title">Login Required</h3>
                                <p class="text-center text-muted small mb-4">Access Questions & Leaderboards</p>

                                <!-- Login Form -->
                                <div id="login-form">
                                    <div class="mb-3">
                                        <input type="email" class="form-control" id="login-email"
                                            placeholder="Email Address">
                                    </div>
                                    <div class="mb-3">
                                        <input type="password" class="form-control" id="login-pass"
                                            placeholder="Password">
                                    </div>
                                    <button class="btn btn-primary w-100 mb-2" onclick="handleLogin()">Login</button>
                                    <div class="text-end mb-3">
                                        <a href="#" class="text-decoration-none small" onclick="toggleForgotPassword(true)">Forgot Password?</a>
                                    </div>
                                    <div class="text-center">
                                        <small>Don't have an account? <a href="#"
                                                onclick="toggleAuthMode(true)">Register</a></small>
                                    </div>
                                </div>

                                <!-- Register Form -->
                                <div id="register-form" class="hide">
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="reg-name" placeholder="Full Name">
                                    </div>
                                    <!-- Added User ID Input with Feedback -->
                                    <div class="mb-3 position-relative">
                                        <input type="text" class="form-control" id="reg-userid" placeholder="User ID">
                                        <small id="userid-feedback" class="form-text text-muted"></small>
                                    </div>
                                    <div class="mb-3">
                                        <input type="email" class="form-control" id="reg-email"
                                            placeholder="Email Address">
                                    </div>
                                    <div class="mb-3">
                                        <input type="password" class="form-control" id="reg-pass"
                                            placeholder="Create Password">
                                    </div>
                                    <button class="btn btn-primary w-100 mb-3" id="reg-btn"
                                        onclick="initiateRegister()">Send OTP & Register</button>
                                    <div class="text-center">
                                        <small>Already have an account? <a href="#"
                                                onclick="toggleAuthMode(false)">Login</a></small>
                                    </div>
                                </div>

                                <!-- Forgot Password Request Form -->
                                <div id="forgot-password-form" class="hide">
                                    <div class="mb-3">
                                        <p class="text-muted small">Enter your email to reset password.</p>
                                        <input type="email" class="form-control" id="reset-email" placeholder="Email Address">
                                    </div>
                                    <button class="btn btn-warning w-100 mb-3" id="reset-req-btn" onclick="initiatePasswordReset()">Send Reset OTP</button>
                                    <div class="text-center">
                                        <small><a href="#" onclick="toggleForgotPassword(false)">Back to Login</a></small>
                                    </div>
                                </div>

                                <!-- Password Reset OTP & New Pass Form -->
                                <div id="reset-verify-form" class="hide">
                                    <div class="mb-3">
                                        <p class="text-muted small">Enter OTP sent to your email.</p>
                                        <input type="text" class="form-control text-center mb-2" id="reset-otp-input" placeholder="Enter OTP" maxlength="6">
                                        <input type="password" class="form-control" id="new-password" placeholder="New Password">
                                    </div>
                                    <button class="btn btn-success w-100 mb-3" onclick="verifyResetOTP()">Reset Password</button>
                                    <div class="text-center">
                                        <small><a href="#" onclick="location.reload()">Cancel</a></small>
                                    </div>
                                </div>

                                <!-- OTP Form (Registration) -->
                                <div id="otp-form" class="hide text-center">
                                    <p class="text-muted">Enter the 6-digit code sent to your email.</p>
                                    <div class="mb-3">
                                        <input type="text" class="form-control text-center" id="otp-input"
                                            placeholder="XXXXXX" maxlength="6">
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="verifyOTP()">Verify Code</button>
                                        <button class="btn btn-outline-secondary"
                                            onclick="location.reload()">Cancel</button>
                                    </div>
                                </div>

                                <div id="auth-msg" class="text-danger text-center mt-3 small"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Global Decorated Footer -->
    <footer class="footer-custom">
        <div class="container">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                            style="width: 32px; height: 32px;">
                            <i class="fas fa-stethoscope fa-sm"></i>
                        </div>
                        <h5 class="text-white m-0">Stethoscope & Study</h5>
                    </div>
                    <p class="small mb-4">Empowering medical students worldwide with accessible quizzes, performance
                        tracking, and a competitive learning environment. Join the community today.</p>
                    <div>
                        <a href="#" class="social-btn"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-btn"><i class="fab fa-youtube"></i></a>
                        <a href="#" class="social-btn"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-btn"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="col-md-3">
                    <h6 class="footer-title">Quick Links</h6>
                    <a href="#" onclick="navTo('home')" class="footer-link">Home</a>
                    <a href="Quiz_Dashboard.html" class="footer-link">Questions</a>
                    <a href="leaderboard.html" onclick="checkAuthAndNav('leaderboard')" class="footer-link">Leaderboard</a>
                    <a href="https://www.youtube.com" target="_blank" class="footer-link">Video Tutorials</a>
                </div>
                <div class="col-md-4">
                    <h6 class="footer-title">Contact Support</h6>
                    <p class="small"><i class="fas fa-envelope me-2 text-primary"></i> stethoscope.study99@gmail.com</p>
                    <p class="small"><i class="fas fa-phone me-2 text-primary"></i> +91 (865) 383-6246</p>
                    <div class="mt-3">
                        <a href="Quiz_Dashboard.html" class="btn btn-outline-light btn-sm rounded-pill px-3">Start
                            Learning</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="copyright-bar text-center small">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 text-md-start mb-2 mb-md-0">
                        &copy; 2025 Stethoscope & Study. All rights reserved.
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="#" class="text-muted text-decoration-none me-3">Privacy Policy</a>
                        <a href="#" class="text-muted text-decoration-none">Terms of Service</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap Bundle JS (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        // Added 'where' to imports
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, orderBy, limit, getDocs, deleteDoc, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // 1. Config (Same as before)
        const firebaseConfig = {
            apiKey: "AIzaSyAxBFlj_kjHb-YeNKwvhhVuQixVOiKNHHw",
            authDomain: "stethoscope-and-study.firebaseapp.com",
            projectId: "stethoscope-and-study",
            storageBucket: "stethoscope-and-study.firebasestorage.app",
            messagingSenderId: "246761756870",
            appId: "1:246761756870:web:74fd6200bcc5d1c76b9fc7",
            measurementId: "G-V9JWTSYHLN"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // EmailJS Init
        (function () { emailjs.init("Ipl1hlV3EArGuB4ZR"); })();
        const SERVICE_ID = "service_1ci2aoi";
        const TEMPLATE_ID = "template_cqt36oa";
        const RESET_TEMPLATE_ID = "template_ybp08k8"; // New Template for Reset

        // 2. Global State
        let currentUser = null;
        let generatedOTP = null;
        let resetOTP = null; // Separate OTP for reset
        let tempUserData = null;
        let resetEmailData = null; // Store email for reset process
        let isUserIdValid = false; // Flag to track ID validity
        let debounceTimer;

        // 4. Initialization
        window.onload = async () => {
            const savedEmail = localStorage.getItem("userEmail");
            if (savedEmail) {
                await fetchUserData(savedEmail);
            }
            updateProfileMenu();
            
            // Add Realtime ID Check Listener
            document.getElementById('reg-userid').addEventListener('input', (e) => {
                const userid = e.target.value.trim();
                const feedback = document.getElementById('userid-feedback');
                const regBtn = document.getElementById('reg-btn');
                
                clearTimeout(debounceTimer);
                isUserIdValid = false;
                regBtn.disabled = true; // Disable button while checking
                
                if(userid.length < 3) {
                    feedback.innerText = "ID must be at least 3 chars";
                    feedback.className = "form-text text-muted";
                    return;
                }

                feedback.innerText = "Checking availability...";
                feedback.className = "form-text text-primary";

                debounceTimer = setTimeout(async () => {
                    const q = query(collection(db, "users"), where("user_id", "==", userid));
                    const snap = await getDocs(q);
                    
                    if (!snap.empty) {
                        feedback.innerText = "User ID already exists!";
                        feedback.className = "form-text text-danger";
                        isUserIdValid = false;
                        regBtn.disabled = true;
                    } else {
                        feedback.innerText = "User ID available";
                        feedback.className = "form-text text-success";
                        isUserIdValid = true;
                        regBtn.disabled = false;
                    }
                }, 500); // 500ms delay
            });
        };

        // ================= NAVIGATION LOGIC =================

        window.navTo = (sectionId) => {
            // Collapse Mobile Menu if open
            const navBarCollapse = document.getElementById('navbarNav');
            const bsCollapse = new bootstrap.Collapse(navBarCollapse, { toggle: false });
            bsCollapse.hide();

            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));

            if (sectionId === 'home') document.getElementById('section-home').classList.add('active');
        };

        window.checkAuthAndNav = (feature) => {
            // Collapse Mobile Menu if open
            const navBarCollapse = document.getElementById('navbarNav');
            const bsCollapse = new bootstrap.Collapse(navBarCollapse, { toggle: false });
            bsCollapse.hide();

            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));

            if (!currentUser) {
                document.getElementById('section-auth').classList.add('active');
            } else {
                // Modified: Removed invalid Logic that tried to access missing #section-leaderboard
            }
        };

        // Replaced custom dropdown logic with Bootstrap Dropdown structure updates
        function updateProfileMenu() {
            const menu = document.getElementById('profile-menu-items');
            const userNameDisplay = document.getElementById('nav-user-name');
            const profileLink = document.getElementById('navbarDropdown');

            if (currentUser) {
                // Logged In
                userNameDisplay.innerText = currentUser.name.split(' ')[0]; // Show first name
                menu.innerHTML = `
                    <li><h6 class="dropdown-header">Signed in as ${currentUser.name}</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="leaderboard.html" onclick="checkAuthAndNav('leaderboard')">Your Score</a></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Logout</a></li>
                `;
            } else {
                // Logged Out
                userNameDisplay.innerText = "Guest";
                menu.innerHTML = `
                    <li><a class="dropdown-item" href="#" onclick="checkAuthAndNav('question')">Login</a></li>
                `;
            }
        }

        // ================= AUTH LOGIC =================
        function hashPassword(p) { return CryptoJS.SHA256(p).toString(); }
        function generateOTP() { return Math.floor(100000 + Math.random() * 900000).toString(); }

        window.toggleAuthMode = (isRegister) => {
            document.getElementById('auth-title').innerText = isRegister ? "Create Account" : "Login Required";
            document.getElementById('login-form').classList.toggle('hide', isRegister);
            document.getElementById('register-form').classList.toggle('hide', !isRegister);
            // Ensure other forms are hidden
            document.getElementById('forgot-password-form').classList.add('hide');
            document.getElementById('reset-verify-form').classList.add('hide');
        };

        window.toggleForgotPassword = (show) => {
            document.getElementById('auth-title').innerText = show ? "Reset Password" : "Login Required";
            document.getElementById('login-form').classList.toggle('hide', show);
            document.getElementById('forgot-password-form').classList.toggle('hide', !show);
            document.getElementById('auth-msg').innerText = "";
        };

        // --- PASSWORD RESET LOGIC ---
        window.initiatePasswordReset = async () => {
            const email = document.getElementById('reset-email').value.trim().toLowerCase();
            const msg = document.getElementById('auth-msg');
            const btn = document.getElementById('reset-req-btn');

            if(!email) { msg.innerText = "Please enter your email."; return; }

            try {
                // Check if user exists
                const userRef = doc(db, "users", email);
                const snap = await getDoc(userRef);
                
                if(!snap.exists()) {
                    msg.innerText = "No account found with this email.";
                    return;
                }

                const userData = snap.data();
                resetOTP = generateOTP();
                resetEmailData = email;

                btn.innerText = "Sending OTP...";
                btn.disabled = true;

                // Send Reset OTP
                await emailjs.send(SERVICE_ID, RESET_TEMPLATE_ID, { 
                    name: userData.name, 
                    otp: resetOTP, 
                    to_email: email 
                });

                // Show Verification Form
                document.getElementById('forgot-password-form').classList.add('hide');
                document.getElementById('reset-verify-form').classList.remove('hide');
                msg.innerText = "";

            } catch(e) {
                console.error(e);
                msg.innerText = "Error sending email. Try again.";
                btn.innerText = "Send Reset OTP";
                btn.disabled = false;
            }
        };

        window.verifyResetOTP = async () => {
            const otp = document.getElementById('reset-otp-input').value;
            const newPass = document.getElementById('new-password').value;
            
            if(otp !== resetOTP) {
                alert("Invalid OTP");
                return;
            }
            if(!newPass || newPass.length < 6) {
                alert("Password must be at least 6 characters");
                return;
            }

            try {
                const userRef = doc(db, "users", resetEmailData);
                await updateDoc(userRef, {
                    password: hashPassword(newPass)
                });
                
                alert("Password reset successful! Please login.");
                location.reload(); // Reload to show login screen cleanly
            } catch(e) {
                console.error(e);
                alert("Error updating password.");
            }
        };

        // --- REGISTER LOGIC ---
        window.initiateRegister = async () => {
            const name = document.getElementById('reg-name').value;
            // Capture User ID
            const userid = document.getElementById('reg-userid').value.trim();
            const email = document.getElementById('reg-email').value.trim().toLowerCase();
            const pass = document.getElementById('reg-pass').value;
            const msg = document.getElementById('auth-msg');

            // Added check for userid
            if (!name || !email || !pass || !userid) { msg.innerText = "Please fill all fields"; return; }
            
            // Double check validation before proceeding
            if (!isUserIdValid) {
                msg.innerText = "Please choose a unique User ID";
                return;
            }

            try {
                // Check if Email exists
                const userRef = doc(db, "users", email);
                const snap = await getDoc(userRef);
                if (snap.exists()) { msg.innerText = "Email already registered. Please Login."; return; }

                generatedOTP = generateOTP();
                // Add userid to tempUserData
                tempUserData = { name, email, pass, userid };

                const btn = document.getElementById('reg-btn');
                const originalText = btn.innerText;
                btn.innerText = "Sending OTP...";
                btn.disabled = true;

                await emailjs.send(SERVICE_ID, TEMPLATE_ID, { name, otp: generatedOTP, to_email: email });

                btn.innerText = originalText;
                btn.disabled = false;

                document.getElementById('register-form').classList.add('hide');
                document.getElementById('otp-form').classList.remove('hide');

            } catch (e) {
                console.error(e);
                msg.innerText = "Error sending email. Please try again.";
                document.getElementById('reg-btn').disabled = false;
                document.getElementById('reg-btn').innerText = "Send OTP & Register";
            }
        };

        window.verifyOTP = async () => {
            const input = document.getElementById('otp-input').value;
            if (input === generatedOTP) {
                try {
                    // Save user to Firestore with the new DBML structure (user_id field included)
                    const newUser = { 
                        name: tempUserData.name, 
                        user_id: tempUserData.userid, // Saving the User ID
                        email: tempUserData.email, 
                        password: hashPassword(tempUserData.pass), 
                        is_verified: true, // As per DBML
                        created_at: new Date(), // As per DBML
                        completedSets: [] // Legacy support
                    };
                    await setDoc(doc(db, "users", tempUserData.email), newUser);
                    alert("Registration Successful!");
                    loginSuccess(newUser);
                } catch (e) { console.error(e); }
            } else { alert("Invalid OTP. Please check your email."); }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const pass = document.getElementById('login-pass').value;
            if (!email || !pass) return;

            try {
                const snap = await getDoc(doc(db, "users", email));
                if (snap.exists() && snap.data().password === hashPassword(pass)) {
                    loginSuccess(snap.data());
                } else {
                    document.getElementById('auth-msg').innerText = "Invalid email or password";
                }
            } catch (e) { console.error(e); document.getElementById('auth-msg').innerText = "Login error"; }
        };

        function loginSuccess(user) {
            currentUser = user;
            localStorage.setItem("userEmail", user.email);
            updateProfileMenu();
            window.navTo('home');
        }

        async function fetchUserData(email) {
            const snap = await getDoc(doc(db, "users", email));
            if (snap.exists()) loginSuccess(snap.data());
        }

        window.logout = () => {
            currentUser = null;
            localStorage.removeItem("userEmail");
            location.reload();
        };
    </script>
</body>

</html>