<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Global Leaderboard - Stethoscope & Study</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --primary-color: #0d6efd;
            --nav-height: 76px;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background: #f0f2f5;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: var(--nav-height);
        }

        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            z-index: -1;
            opacity: 0.9;
        }

        /* Navbar Matches Index */
        .navbar {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .nav-link { position: relative; color: #555 !important; font-weight: 500; transition: color 0.3s ease; }
        .nav-link:hover, .nav-link.active { color: var(--primary-color) !important; }

        /* Custom Cards */
        .card-custom {
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }
        .card-custom:hover { transform: translateY(-5px); }

        .score-card-border-top { border-top: 4px solid var(--primary-color); }
        .score-card-gold { border-top: 4px solid #ffc107; }

        /* Custom Toggle Switch */
        .toggle-container {
            background: #e2e8f0;
            padding: 0.3rem;
            border-radius: 50px;
            display: inline-flex;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
            margin-bottom: 2rem;
        }
        .toggle-btn {
            border: none;
            background: transparent;
            padding: 0.6rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toggle-btn:hover { color: #475569; }
        .toggle-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Table Styling */
        .table-container {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background: white;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .table-custom { margin-bottom: 0; }
        .table thead th { 
            background: #f8fafc; 
            color: #475569; 
            font-weight: 600; 
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            padding: 1rem 1.5rem;
            border-bottom: 2px solid #e2e8f0; 
        }
        .table tbody td {
            padding: 1rem 1.5rem;
            vertical-align: middle;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            font-weight: 500;
        }
        .table tbody tr:last-child td { border-bottom: none; }
        .table tbody tr:hover { background-color: #f8fafc; }
        
        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            margin: 0 auto;
        }
        .rank-1 { background: #fef3c7; color: #d97706; border: 1px solid #fcd34d; }
        .rank-2 { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
        .rank-3 { background: #fff7ed; color: #ea580c; border: 1px solid #fed7aa; }
        .rank-other { color: #64748b; }

        /* Footer Matches Index */
        .footer-custom {
            background-color: #1e293b;
            color: #94a3b8;
            padding-top: 3rem;
            margin-top: 4rem;
            border-top: 4px solid var(--primary-color);
        }
        .footer-title {
            color: #fff;
            font-weight: 600;
            margin-bottom: 1.2rem;
            position: relative;
            display: inline-block;
        }
        .footer-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 40px;
            height: 2px;
            background-color: var(--primary-color);
        }
        .footer-link {
            color: #94a3b8;
            text-decoration: none;
            display: block;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .footer-link:hover { color: #fff; padding-left: 5px; }
        .social-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            margin-right: 8px;
            transition: all 0.3s;
            text-decoration: none;
        }
        .social-btn:hover { background: var(--primary-color); transform: translateY(-3px); color: #fff; }
        .copyright-bar { background-color: #0f172a; padding: 1.5rem 0; margin-top: 3rem; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <span class="fw-bold" style="color: #333;">Stethoscope & <span class="text-primary">Study</span></span>
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-3">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="Quiz_Dashboard.html">Quiz Portal</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#">Leaderboard</a></li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle btn btn-light rounded-pill px-3" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="border: 1px solid #eee;">
                            <i class="fas fa-user-circle fa-lg me-1"></i> <span id="nav-user-name">Account</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0" id="profile-menu-items">
                            <li><a class="dropdown-item" href="index.html">Login</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container py-5">
        <div class="text-center mb-4">
            <h2 class="fw-bold mb-2">Global Leaderboard</h2>
            <p class="text-muted">Compete with medical students worldwide and track your standing.</p>
        </div>

        <!-- Toggle Controls -->
        <div class="text-center">
            <div class="toggle-container">
                <button class="toggle-btn active" id="btn-monthly" onclick="setLeaderboardView('monthly')">
                    <i class="far fa-calendar-alt"></i> Monthly (Top 100)
                </button>
                <button class="toggle-btn" id="btn-alltime" onclick="setLeaderboardView('alltime')">
                    <i class="fas fa-trophy"></i> This Year (Top 200)
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card card-custom h-100 score-card-border-top p-4 text-center">
                    <div class="card-body">
                        <div class="mb-3 text-primary opacity-75"><i class="fas fa-user-circle fa-2x"></i></div>
                        <h6 class="text-uppercase text-muted small ls-1">Your Rank</h6>
                        <h2 class="display-5 fw-bold text-primary my-2" id="user-rank-display">-</h2>
                        <small id="user-name-display" class="text-muted fw-bold">Guest</small>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-custom h-100 score-card-border-top p-4 text-center">
                    <div class="card-body">
                        <div class="mb-3 text-secondary opacity-75"><i class="fas fa-medal fa-2x"></i></div>
                        <h6 class="text-uppercase text-muted small ls-1">Your Score</h6>
                        <h2 class="display-5 fw-bold text-dark my-2" id="lb-user-score">0</h2>
                        <small class="text-success fw-bold"><i class="fas fa-arrow-up"></i> Keep pushing!</small>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-custom h-100 score-card-gold p-4 text-center">
                    <div class="card-body">
                        <div class="mb-3 text-warning opacity-75"><i class="fas fa-crown fa-2x"></i></div>
                        <h6 class="text-uppercase text-muted small ls-1">Top Score (<span id="top-score-label">Monthly</span>)</h6>
                        <h2 class="display-5 fw-bold text-warning my-2" id="lb-top-score">-</h2>
                        <small id="lb-top-name" class="text-muted fw-bold">Loading...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Table -->
        <div class="table-container">
            <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold ps-2"><i class="fas fa-list-ol text-primary me-2"></i>Rankings</h5>
                <span class="badge bg-light text-secondary border" id="ranking-period-badge">Monthly View</span>
            </div>
            <div class="table-responsive">
                <table class="table table-custom table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col" class="text-center" style="width: 100px;">Rank</th>
                            <th scope="col">Student Name</th>
                            <th scope="col" class="text-end pe-4">Score</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="3" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Fetching data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Global Decorated Footer -->
    <footer class="footer-custom">
        <div class="container">
            <div class="row g-4">
                <div class="col-md-5">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                            <i class="fas fa-stethoscope fa-sm"></i>
                        </div>
                        <h5 class="text-white m-0">Stethoscope & Study</h5>
                    </div>
                    <p class="small mb-4">Empowering medical students worldwide with accessible quizzes, performance tracking, and a competitive learning environment. Join the community today.</p>
                    <div>
                        <a href="#" class="social-btn"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-btn"><i class="fab fa-youtube"></i></a>
                        <a href="#" class="social-btn"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-btn"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="col-md-3">
                    <h6 class="footer-title">Quick Links</h6>
                    <a href="index.html" class="footer-link">Home</a>
                    <a href="Quiz_Dashboard.html" class="footer-link">Questions</a>
                    <a href="#" class="footer-link">Leaderboard</a>
                    <a href="https://www.youtube.com" target="_blank" class="footer-link">Video Tutorials</a>
                </div>
                <div class="col-md-4">
                    <h6 class="footer-title">Contact Support</h6>
                    <p class="small"><i class="fas fa-envelope me-2 text-primary"></i> stethoscope.study99@gmail.com</p>
                    <p class="small"><i class="fas fa-phone me-2 text-primary"></i> +91 (865) 383-6246</p>
                    <div class="mt-3">
                        <a href="Quiz_Dashboard.html" class="btn btn-outline-light btn-sm rounded-pill px-3">Start Learning</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="copyright-bar text-center small">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 text-md-start mb-2 mb-md-0">
                        &copy; 2025 Stethoscope & Study. All rights reserved.
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="#" class="text-muted text-decoration-none me-3">Privacy Policy</a>
                        <a href="#" class="text-muted text-decoration-none">Terms of Service</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAxBFlj_kjHb-YeNKwvhhVuQixVOiKNHHw",
            authDomain: "stethoscope-and-study.firebaseapp.com",
            projectId: "stethoscope-and-study",
            storageBucket: "stethoscope-and-study.firebasestorage.app",
            messagingSenderId: "246761756870",
            appId: "1:246761756870:web:74fd6200bcc5d1c76b9fc7",
            measurementId: "G-V9JWTSYHLN"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let currentView = 'monthly'; // 'monthly' or 'alltime'

        window.onload = async () => {
            const savedEmail = localStorage.getItem("userEmail");
            
            if (!savedEmail) {
                updateProfileMenu(null);
            } else {
                try {
                    const userSnap = await getDoc(doc(db, "users", savedEmail));
                    if(userSnap.exists()) {
                        currentUser = userSnap.data();
                        updateProfileMenu(currentUser);
                        document.getElementById('user-name-display').innerText = currentUser.name;
                        // Default to monthly score on load, will update in setLeaderboardView
                        document.getElementById('lb-user-score').innerText = currentUser.monthly_score || 0;
                    }
                } catch(e) { console.error("User fetch error", e); }
            }

            // Initial Load
            setLeaderboardView('monthly');
        };

        // Exposed Function for Toggle
        window.setLeaderboardView = (view) => {
            currentView = view;
            
            // UI Updates
            document.getElementById('btn-monthly').classList.toggle('active', view === 'monthly');
            document.getElementById('btn-alltime').classList.toggle('active', view === 'alltime');
            
            const limitCount = view === 'monthly' ? 100 : 200;
            const viewLabel = view === 'monthly' ? 'Monthly' : 'This Year';
            
            document.getElementById('top-score-label').innerText = viewLabel;
            document.getElementById('ranking-period-badge').innerText = viewLabel + " View";
            
            // Update current user score card based on view
            if (currentUser) {
                const scoreToShow = view === 'monthly' ? (currentUser.monthly_score || 0) : (currentUser.total_score || 0);
                document.getElementById('lb-user-score').innerText = scoreToShow;
            }

            loadLeaderboardData(limitCount, view);
        };

        function updateProfileMenu(user) {
            const menu = document.getElementById('profile-menu-items');
            const userNameDisplay = document.getElementById('nav-user-name');
            
            if (user) {
                userNameDisplay.innerText = user.name.split(' ')[0];
                menu.innerHTML = `
                    <li><h6 class="dropdown-header">Signed in as ${user.name}</h6></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="Quiz_Dashboard.html">Take Quiz</a></li>
                    <li><a class="dropdown-item text-danger" href="#" id="logout-btn">Logout</a></li>
                `;
                setTimeout(() => {
                    document.getElementById('logout-btn').addEventListener('click', () => {
                        localStorage.removeItem("userEmail");
                        window.location.href = "index.html";
                    });
                }, 500);
            }
        }

        async function loadLeaderboardData(limitCount, view) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = `<tr><td colspan="3" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading ${limitCount} records...</td></tr>`;
            
            try {
                // Determine sort field based on view
                // DBML implication: 'users' collection has 'monthly_score' and 'total_score' fields
                const sortField = view === 'monthly' ? 'monthly_score' : 'total_score';

                // Query 'users' collection instead of 'leaderboard'
                const q = query(collection(db, "users"), orderBy(sortField, "desc"), limit(limitCount));
                const snap = await getDocs(q);
                
                tbody.innerHTML = "";
                let rank = 1;
                let topScore = 0; 
                let topName = "-";
                let userRank = "-";

                snap.forEach((doc) => {
                    const data = doc.data();
                    const score = data[sortField] || 0; // Dynamic score access

                    // Capture Top Scorer
                    if(rank === 1) { 
                        topScore = score; 
                        topName = data.name; 
                    }

                    // Check if this row is the current user
                    let isCurrentUser = (currentUser && data.email === currentUser.email);
                    if (isCurrentUser) userRank = "#" + rank;
                    
                    // Formatting Rank Badges
                    let rankBadgeClass = "rank-other";
                    let rowClass = "";
                    let icon = "";
                    
                    if(rank === 1) { rankBadgeClass = "rank-1"; icon = '<i class="fas fa-crown"></i>'; rowClass = "table-warning"; }
                    else if(rank === 2) { rankBadgeClass = "rank-2"; icon = "2"; }
                    else if(rank === 3) { rankBadgeClass = "rank-3"; icon = "3"; }
                    else { icon = rank; }

                    if (isCurrentUser) rowClass = "table-primary border-primary"; 

                    tbody.innerHTML += `
                        <tr class="${rowClass}">
                            <td class="text-center"><div class="rank-badge ${rankBadgeClass}">${icon}</div></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3 border" style="width: 36px; height: 36px; color: #aaa;">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <span class="fw-bold text-dark">${data.name}</span>
                                        ${isCurrentUser ? '<span class="badge bg-primary ms-2" style="font-size: 0.65rem;">YOU</span>' : ''}
                                    </div>
                                </div>
                            </td>
                            <td class="text-end pe-4"><span class="fw-bold text-primary">${score}</span></td>
                        </tr>`;
                    rank++;
                });

                if (snap.empty) {
                    tbody.innerHTML = "<tr><td colspan='3' class='text-center py-5 text-muted'>No ranking data available yet.</td></tr>";
                }

                // Update Stats
                document.getElementById('lb-top-score').innerText = topScore;
                document.getElementById('lb-top-name').innerText = topName;
                document.getElementById('user-rank-display').innerText = userRank;

            } catch (e) {
                console.error("Leaderboard Error", e);
                tbody.innerHTML = "<tr><td colspan='3' class='text-center text-danger py-5'>Unable to load rankings. Please try again later.</td></tr>";
            }
        }
    </script>
</body>
</html>